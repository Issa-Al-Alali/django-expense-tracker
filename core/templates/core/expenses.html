{% extends "core/base.html" %}

{% block content %}
<div class="container">
    <h1>My Expenses</h1>
    
    <div class="row">
        <!-- Left Column - Filters -->
        <div class="col-md-6">
            <!-- Filter Section -->
            <div class="filter-section mb-4">
                <form id="filter-form" class="row g-3">
                    <div class="col-12">
                        <label for="year" class="form-label">Year</label>
                        <input type="text" id="year" name="year" class="form-control" value="{{ filters.year|default:'' }}" placeholder="Enter year (e.g., 2025)">
                    </div>
                    <div class="col-12">
                        <label for="month" class="form-label">Month</label>
                        <input type="text" id="month" name="month" class="form-control" value="{{ filters.month|default:'' }}" placeholder="Enter month (1-12)">
                    </div>
                    <div class="col-12">
                        <label for="category_name" class="form-label">Category</label>
                        <select id="category_name" name="category_name" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.name }}" {% if filters.category_name == category.name %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="sort" class="form-label">Sort by Amount</label>
                        <select id="sort" name="sort" class="form-select">
                            <option value="">No Sorting</option>
                            <option value="asc" {% if filters.sort == 'asc' %}selected{% endif %}>Ascending</option>
                            <option value="desc" {% if filters.sort == 'desc' %}selected{% endif %}>Descending</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <button type="button" id="reset-filters" class="btn btn-secondary">Reset</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Right Column - Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Expense Visualization</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary chart-type-btn active" data-type="monthly">
                            <i class="bi bi-calendar-month"></i> By Month
                        </button>
                        <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="category">
                            <i class="bi bi-tags"></i> By Category
                        </button>
                    </div>
                </div>
                <div class="card-body" style="height: 540px;">  <!-- Adjust this value as needed -->
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Expense Button -->
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
        <i class="bi bi-plus"></i> Add Expense
    </button>
    
    <!-- Expenses Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.expense_date }}</td>
                    <td>{{ expense.category_name }}</td>
                    <td>{{ expense.description }}</td>
                    <td>${{ expense.amount }}</td>
                    <td>{{ expense.location }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-expense" 
                                data-id="{{ expense.id }}"
                                data-amount="{{ expense.amount }}"
                                data-description="{{ expense.description }}"
                                data-date="{{ expense.expense_date }}"
                                data-location="{{ expense.location }}"
                                data-category="{{ expense.category }}"
                                data-bs-toggle="modal" 
                                data-bs-target="#editExpenseModal">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-expense" 
                               data-id="{{ expense.id }}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No expenses found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-expense-form" method="post" action="{% url 'add_expense' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label for="expense_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="expense_date" name="expense_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-expense-form" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="edit_amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_expense_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="edit_expense_date" name="expense_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="edit_location" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="edit_category" class="form-label">Category</label>
                        <select class="form-select" id="edit_category" name="category" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const userIncome = {{ income|default:0 }};
    $(document).ready(function() {
        // Initialize chart variables
        let expenseChart;
        const chartCtx = document.getElementById('expenseChart').getContext('2d');
        
        // Function to initialize or update the chart
        // In your section, replace the updateChart function with this:

        function updateChart(type = 'monthly') {
            const year = $('#year').val().trim();
            const month = $('#month').val().trim();
            const token = "{{ request.session.token }}";
            const user_id = "{{ request.session.user_id }}";
            
            // Clear any previous chart
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            // Clear the canvas
            chartCtx.clearRect(0, 0, chartCtx.canvas.width, chartCtx.canvas.height);
            
            if (type === 'monthly' && !year) {
                // Show message to select a year for monthly view
                chartCtx.font = '16px Arial';
                chartCtx.textAlign = 'center';
                chartCtx.fillText('Please select a year to view monthly expenses', 
                                chartCtx.canvas.width / 2, 
                                chartCtx.canvas.height / 2);
                return;
            }
            
            // Determine the API endpoint based on chart type
            let endpoint;
            if (type === 'monthly') {
                endpoint = `/expenses/${user_id}/monthly-summary/?year=${year}`;
                if (month) {
                    endpoint += `&month=${month}`;
                }
            } else {
                // For category view, include current filters except month
                const params = new URLSearchParams();
                if (year) params.set('year', year);
                if ($('#category_name').val()) params.set('category_name', $('#category_name').val());
                endpoint = `/expenses/${user_id}/category-summary/?${params.toString()}`;
            }
            
            // Make AJAX request to get chart data
            $.ajax({
                url: endpoint,
                method: 'GET',
                headers: {
                    'Authorization': `Token ${token}`
                },
                success: function(response) {
                    // Clear any previous chart
                    if (expenseChart) {
                        expenseChart.destroy();
                    }
                    
                    // Check if we have data
                    if (!response.labels || !response.data || response.data.length === 0) {
                        chartCtx.font = '16px Arial';
                        chartCtx.textAlign = 'center';
                        chartCtx.fillText('No data available for the selected filters', 
                                        chartCtx.canvas.width / 2, 
                                        chartCtx.canvas.height / 2);
                        return;
                    }
                    
                    // Use the labels and data directly from the response
                    const labels = response.labels;
                    const data = response.data;
                    
                    const backgroundColor = type === 'monthly' 
                        ? Array(data.length).fill('rgba(54, 162, 235, 0.5)')
                        : generateCategoryColors(labels.length);
                    
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            label: type === 'monthly' ? `Monthly Expenses for ${year}` : 'Expenses by Category',
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: type === 'monthly' 
                                ? Array(data.length).fill('rgba(54, 162, 235, 1)')
                                : backgroundColor.map(color => color.replace('0.5', '1')),
                            borderWidth: 1
                        }]
                    };
                    
                    // Create new chart
                    expenseChart = new Chart(chartCtx, {
                        responsive: true,
                        maintainAspectRatio: false,
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '$' + context.raw.toFixed(2);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Amount ($)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value;
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: type === 'monthly' ? 'Month' : 'Category'
                                    }
                                }
                            }
                        }
                    });
                },
                error: function(xhr) {
                    console.error('Error fetching chart data:', xhr);
                    chartCtx.font = '16px Arial';
                    chartCtx.textAlign = 'center';
                    chartCtx.fillText('Error loading chart data', 
                                    chartCtx.canvas.width / 2, 
                                    chartCtx.canvas.height / 2);
                }
            });
        }
        
        // Helper function to generate colors for categories
        function generateCategoryColors(count) {
            const colors = [];
            const hueStep = 360 / count;
            for (let i = 0; i < count; i++) {
                const hue = i * hueStep;
                colors.push(`hsla(${hue}, 70%, 50%, 0.5)`);
            }
            return colors;
        }
        
        // Chart type switcher
        $('.chart-type-btn').click(function() {
            $('.chart-type-btn').removeClass('active');
            $(this).addClass('active');
            const chartType = $(this).data('type');
            updateChart(chartType);
        });

        // Initialize chart on page load
        const initialYear = $('#year').val();
        if (initialYear) {
            updateChart('monthly');
        } else {
            // Show message to select a year
            chartCtx.font = '16px Arial';
            chartCtx.textAlign = 'center';
            chartCtx.fillText('     Please select a year to view monthly expenses', 
                            chartCtx.canvas.width / 3, 
                            chartCtx.canvas.height / 3);
        }
        
        // Handle filter form submission
        $('#filter-form').on('submit', function(e) {
            const year = $('#year').val().trim();
            const month = $('#month').val().trim();
            
            // Validate year if provided
            if (year && !/^\d{4}$/.test(year)) {
                alert('Please enter a valid 4-digit year');
                e.preventDefault();
                return false;
            }
            
            // Validate month if provided
            if (month) {
                const monthNum = parseInt(month);
                if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) {
                    alert('Please enter a valid month (1-12)');
                    e.preventDefault();
                    return false;
                }
            }
            
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            $('#filter-form').serializeArray().forEach(item => {
                if (item.value) {
                    params.set(item.name, item.value);
                } else {
                    params.delete(item.name);
                }
            });
            
            // Update the chart with the new filters
            const activeChartType = $('.chart-type-btn.active').data('type');
            updateChart(activeChartType);
            
            // Update the URL
            window.location.search = params.toString();
        });
        
        // Reset filters button
        $('#reset-filters').click(function() {
            window.location.search = '';
        });
        
        // Handle add expense form submission
        $('#add-expense-form').on('submit', function (e) {
            e.preventDefault();
        
            const formData = {
                amount: parseFloat($('#amount').val()),
                description: $('#description').val(),
                expense_date: $('#expense_date').val(),
                location: $('#location').val(),
                category: $('#category').val()
            };
        
            const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
        
            // Check if the expense exceeds the income
            if (formData.amount > userIncome) {
                if (!confirm('The expense exceeds your income. Are you sure you want to add this expense?')) {
                    return; // Cancel the submission
                }
            }
        
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function (response) {
                    if (response.success) {
                        $('#addExpenseModal').modal('hide');
                        location.reload();
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'Unknown error';
                    try {
                        const errorResponse = xhr.responseJSON;
                        if (errorResponse && errorResponse.detail) {
                            errorMessage = errorResponse.detail;
                        } else if (errorResponse && errorResponse.errors) {
                            errorMessage = typeof errorResponse.errors === 'string'
                                ? errorResponse.errors
                                : JSON.stringify(errorResponse.errors);
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    alert('Error adding expense: ' + errorMessage);
                }
            });
        });
    
        // Handle edit button click to populate modal
        $('.edit-expense').on('click', function() {
            const expenseId = $(this).data('id');
            $('#edit-expense-form').attr('action', `/expenses/update/${expenseId}/`);
            $('#edit_amount').val($(this).data('amount'));
            $('#edit_description').val($(this).data('description'));
            $('#edit_expense_date').val($(this).data('date'));
            $('#edit_location').val($(this).data('location'));
            $('#edit_category').val($(this).data('category'));
        });

        // Handle delete button click
        $('.delete-expense').on('click', function () {
            const expenseId = $(this).data('id');
            const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
        
            if (confirm('Are you sure you want to delete this expense?')) {
                $.ajax({
                    url: `/expenses/delete/${expenseId}/`,
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    success: function (response) {
                        console.log('Delete success:', response);
                        // Force reload regardless of response structure
                        location.reload();
                    },
                    error: function (xhr) {
                        console.error('Delete error:', xhr);
                        let errorMessage = 'Unknown error';
                        try {
                            const errorResponse = xhr.responseJSON;
                            errorMessage = errorResponse.detail || JSON.stringify(errorResponse);
                        } catch (e) {
                            console.error('Error parsing response:', e);
                        }
                        alert('Delete failed: ' + errorMessage);
                    }
                });
            }
        });
        
        // Handle edit expense form submission
        $('#edit-expense-form').on('submit', function (e) {
            e.preventDefault();

            const formData = {
                amount: parseFloat($('#edit_amount').val()),
                description: $('#edit_description').val(),
                expense_date: $('#edit_expense_date').val(),
                location: $('#edit_location').val(),
                category: $('#edit_category').val()
            };

            const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
            const $modal = $('#editExpenseModal');
            const currentParams = new URLSearchParams(window.location.search);

            // Check if the expense exceeds the income
            if (formData.amount > userIncome) {
                if (!confirm('The expense exceeds your income. Are you sure you want to edit this expense?')) {
                    return; // Cancel the submission
                }
            }

            $.ajax({
                url: $(this).attr('action'),
                method: 'PUT',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function (response) {
                    $modal.modal('hide');

                    // Small delay to ensure modal transitions complete
                    setTimeout(() => {
                        // Preserve filters while reloading
                        window.location.href = "{% url 'frontend-expense-list' %}?" + currentParams.toString();
                    }, 300);
                },
                error: function (xhr) {
                    let errorMessage = 'Unknown error';
                    try {
                        const errorResponse = xhr.responseJSON;
                        errorMessage = errorResponse.detail || JSON.stringify(errorResponse);
                    } catch (e) {
                        console.error('Error parsing response:', e);
                    }
                    alert('Update failed: ' + errorMessage);
                }
            });
        });
    });
</script>
{% endblock %}