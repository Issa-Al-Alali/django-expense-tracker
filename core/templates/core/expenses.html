{% extends "core/base.html" %}

{% block content %}
<div class="container">
    <h1>My Expenses</h1>
    
    <div class="row">
        <!-- Left Column - Filters -->
        <div class="col-md-6">
            <!-- Filter Section -->
            <div class="filter-section mb-4">
                <form id="filter-form" class="row g-3">
                    <div class="col-12">
                        <label for="year" class="form-label">Year</label>
                        <input type="text" id="year" name="year" class="form-control" value="{{ filters.year|default:'' }}" placeholder="Enter year (e.g., 2025)">
                    </div>
                    <div class="col-12">
                        <label for="month" class="form-label">Month</label>
                        <input type="text" id="month" name="month" class="form-control" value="{{ filters.month|default:'' }}" placeholder="Enter month (1-12)">
                    </div>
                    <div class="col-12">
                        <label for="category_name" class="form-label">Category</label>
                        <select id="category_name" name="category_name" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.name }}" {% if filters.category_name == category.name %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="sort" class="form-label">Sort by Amount</label>
                        <select id="sort" name="sort" class="form-select">
                            <option value="">No Sorting</option>
                            <option value="asc" {% if filters.sort == 'asc' %}selected{% endif %}>Ascending</option>
                            <option value="desc" {% if filters.sort == 'desc' %}selected{% endif %}>Descending</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <button type="button" id="reset-filters" class="btn btn-secondary">Reset</button>
                    </div>
                </form>
            </div>
            <div class="col-12 mt-3">
                <button id="download-yearly-pdf" class="btn btn-info">
                    <i class="bi bi-file-earmark-pdf"></i> Download Yearly Summary PDF
                </button>
            </div>
        </div>
        
        <!-- Right Column - Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Expense Visualization</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary chart-type-btn active" data-type="monthly">
                            <i class="bi bi-calendar-month"></i> By Month
                        </button>
                        <button type="button" class="btn btn-outline-primary chart-type-btn" data-type="category">
                            <i class="bi bi-tags"></i> By Category
                        </button>
                    </div>
                </div>
                <div class="card-body" style="height: 540px;">  <!-- Adjust this value as needed -->
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Expense Button -->
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
        <i class="bi bi-plus"></i> Add Expense
    </button>
    
    <!-- Expenses Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Location</th>
                    <th>Receipt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.expense_date }}</td>
                    <td>{{ expense.category_name }}</td>
                    <td>{{ expense.description }}</td>
                    <td>${{ expense.amount }}</td>
                    <td>{{ expense.location }}</td>
                    <td>
                        {% if expense.receipt %}
                            <a href="/media/{{ expense.receipt }}" 
                               class="btn btn-sm btn-info view-receipt"
                               data-receipt-url="{{ expense.receipt }}">
                                <i class="bi bi-file-earmark-pdf"></i> View
                            </a>
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-expense" 
                                data-id="{{ expense.id }}"
                                data-amount="{{ expense.amount }}"
                                data-description="{{ expense.description }}"
                                data-date="{{ expense.expense_date }}"
                                data-location="{{ expense.location }}"
                                data-category="{{ expense.category }}"
                                data-bs-toggle="modal" 
                                data-bs-target="#editExpenseModal">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-expense" 
                               data-id="{{ expense.id }}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No expenses found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-expense-form" method="post" action="{% url 'add_expense' %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label for="expense_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="expense_date" name="expense_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="receipt" class="form-label">Receipt (PDF only)</label>
                        <input type="file" class="form-control" id="receipt" name="receipt" accept=".pdf">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-expense-form" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="edit_amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_expense_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="edit_expense_date" name="expense_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="edit_location" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="edit_category" class="form-label">Category</label>
                        <select class="form-select" id="edit_category" name="category" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script>
    const token ="{{ request.session.token }}";
    const user_id ="{{ request.session.user_id }}";
    const userIncome = {{ income|default:0 }};
    $(document).ready(function() {

        if (!token || !user_id) {
            window.location.href = '/login';  // Redirect to login if no token
            return;
        }
        // Initialize chart variables
        let expenseChart;
        const chartCtx = document.getElementById('expenseChart').getContext('2d');
        
        $('#download-yearly-pdf').on('click', downloadYearlyPDF);

        // Function to initialize or update the chart
        // In your section, replace the updateChart function with this:

        function updateChart(type = 'monthly') {
            const year = $('#year').val().trim();
            const month = $('#month').val().trim();
            const token = "{{ request.session.token }}";
            const user_id = "{{ request.session.user_id }}";
            
            // Clear any previous chart
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            // Clear the canvas
            chartCtx.clearRect(0, 0, chartCtx.canvas.width, chartCtx.canvas.height);
            
            if (type === 'monthly' && !year) {
                // Show message to select a year for monthly view
                chartCtx.font = '16px Arial';
                chartCtx.textAlign = 'center';
                chartCtx.fillText('     Please select a year to view monthly expenses', 
                                chartCtx.canvas.width / 2, 
                                chartCtx.canvas.height / 2);
                return;
            }
            
            // Determine the API endpoint based on chart type
            let endpoint;
            if (type === 'monthly') {
                endpoint = `/expenses/${user_id}/monthly-summary/?year=${year}`;
                if (month) {
                    endpoint += `&month=${month}`;
                }
            } else {
                // For category view, include current filters except month
                const params = new URLSearchParams();
                if (year) params.set('year', year);
                if ($('#category_name').val()) params.set('category_name', $('#category_name').val());
                endpoint = `/expenses/${user_id}/category-summary/?${params.toString()}`;
            }
            
            // Make AJAX request to get chart data
            $.ajax({
                url: endpoint,
                method: 'GET',
                headers: {
                    'Authorization': `Token ${token}`
                },
                success: function(response) {
                    // Clear any previous chart
                    if (expenseChart) {
                        expenseChart.destroy();
                    }
                    
                    // Check if we have data
                    if (!response.labels || !response.data || response.data.length === 0) {
                        chartCtx.font = '16px Arial';
                        chartCtx.textAlign = 'center';
                        chartCtx.fillText('No data available for the selected filters', 
                                        chartCtx.canvas.width / 2, 
                                        chartCtx.canvas.height / 2);
                        return;
                    }
                    
                    // Use the labels and data directly from the response
                    const labels = response.labels;
                    const data = response.data;
                    
                    const backgroundColor = type === 'monthly' 
                        ? Array(data.length).fill('rgba(54, 162, 235, 0.5)')
                        : generateCategoryColors(labels.length);
                    
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            label: type === 'monthly' ? `Monthly Expenses for ${year}` : 'Expenses by Category',
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: type === 'monthly' 
                                ? Array(data.length).fill('rgba(54, 162, 235, 1)')
                                : backgroundColor.map(color => color.replace('0.5', '1')),
                            borderWidth: 1
                        }]
                    };
                    
                    // Create new chart
                    expenseChart = new Chart(chartCtx, {
                        responsive: true,
                        maintainAspectRatio: false,
                        type: 'bar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '$' + context.raw.toFixed(2);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Amount ($)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value;
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: type === 'monthly' ? 'Month' : 'Category'
                                    }
                                }
                            }
                        }
                    });
                },
                error: function(xhr) {
                    console.error('Error fetching chart data:', xhr);
                    chartCtx.font = '16px Arial';
                    chartCtx.textAlign = 'center';
                    chartCtx.fillText('Error loading chart data', 
                                    chartCtx.canvas.width / 2, 
                                    chartCtx.canvas.height / 2);
                }
            });
        }
        
        // Helper function to generate colors for categories
        function generateCategoryColors(count) {
            const colors = [];
            const hueStep = 360 / count;
            for (let i = 0; i < count; i++) {
                const hue = i * hueStep;
                colors.push(`hsla(${hue}, 70%, 50%, 0.5)`);
            }
            return colors;
        }
        
        // Chart type switcher
        $('.chart-type-btn').click(function() {
            $('.chart-type-btn').removeClass('active');
            $(this).addClass('active');
            const chartType = $(this).data('type');
            updateChart(chartType);
        });

        // Initialize chart on page load
        const initialYear = $('#year').val();
        if (initialYear) {
            updateChart('monthly');
        } else {
            // Show message to select a year
            chartCtx.font = '16px Arial';
            chartCtx.textAlign = 'center';
            chartCtx.fillText('     Please select a year to view monthly expenses', 
                            chartCtx.canvas.width / 3, 
                            chartCtx.canvas.height / 3);
        }
        
        // Handle filter form submission
        $('#filter-form').on('submit', function(e) {
            const year = $('#year').val().trim();
            const month = $('#month').val().trim();
            
            // Validate year if provided
            if (year && !/^\d{4}$/.test(year)) {
                alert('Please enter a valid 4-digit year');
                e.preventDefault();
                return false;
            }
            
            // Validate month if provided
            if (month) {
                const monthNum = parseInt(month);
                if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) {
                    alert('Please enter a valid month (1-12)');
                    e.preventDefault();
                    return false;
                }
            }
            
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            $('#filter-form').serializeArray().forEach(item => {
                if (item.value) {
                    params.set(item.name, item.value);
                } else {
                    params.delete(item.name);
                }
            });
            
            // Update the chart with the new filters
            const activeChartType = $('.chart-type-btn.active').data('type');
            updateChart(activeChartType);
            
            // Update the URL
            window.location.search = params.toString();
        });
        
        // Reset filters button
        $('#reset-filters').click(function() {
            window.location.search = '';
        });
        
        // Handle add expense form submission
        $('#add-expense-form').on('submit', function(e) {
            e.preventDefault();
            
            const userId = "{{ request.session.user_id }}";  // Get user ID from session

            const categoryName = $('#category option:selected').text();  // Get selected category name
            const formData = new FormData();
            formData.append('amount', $('#amount').val());
            formData.append('description', $('#description').val());
            formData.append('expense_date', $('#expense_date').val());
            formData.append('location', $('#location').val());
            formData.append('category', $('#category').val());
            
            const receiptFile = $('#receipt')[0].files[0];
            if (receiptFile) {
                formData.append('receipt', receiptFile);
            }
        
            // Determine content type based on whether we have a file
            const contentType = receiptFile ? false : 'application/json';
        
        
            // Check if the expense exceeds the income
            if (formData.amount > userIncome) {
                if (!confirm('The expense exceeds your income. Are you sure you want to add this expense?')) {
                    return; // Cancel the submission
                }
            }
        
            const apiUrl = `/expenses/add/${userId}/${encodeURIComponent(categoryName)}/`;
            console.log('API URL:', apiUrl);  // Add this before the AJAX call
            $.ajax({
                url: apiUrl,
                method: 'POST',
                data: receiptFile ? formData : JSON.stringify(Object.fromEntries(formData)),
                processData: false,
                contentType: contentType,
                headers: {
                    'Authorization': `Token ${token}`,
                },
                success: function(response) {
                    $('#addExpenseModal').modal('hide');
                    location.reload();
                },
                error: function(xhr) {
                    let errorMessage = 'Unknown error occurred';
                    try {
                        const errorResponse = xhr.responseJSON;
                        if (errorResponse && errorResponse.detail) {
                            errorMessage = errorResponse.detail;
                        } else if (errorResponse && errorResponse.errors) {
                            errorMessage = typeof errorResponse.errors === 'string' 
                                ? errorResponse.errors 
                                : JSON.stringify(errorResponse.errors);
                        }
                    } catch(e) {
                        console.error('Error parsing error response:', e);
                    }
                    alert('Error: ' + errorMessage);
                }
            });
        });
    
        // Handle edit button click to populate modal
        $('.edit-expense').on('click', function() {
            const expenseId = $(this).data('id');
            $('#edit-expense-form').attr('action', `/expenses/update/${expenseId}/`);
            $('#edit_amount').val($(this).data('amount'));
            $('#edit_description').val($(this).data('description'));
            $('#edit_expense_date').val($(this).data('date'));
            $('#edit_location').val($(this).data('location'));
            $('#edit_category').val($(this).data('category'));
        });

        // Handle delete button click
        $('.delete-expense').on('click', function () {
            const expenseId = $(this).data('id');
        
            if (confirm('Are you sure you want to delete this expense?')) {
                $.ajax({
                    url: `/expenses/delete/${expenseId}/`,
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Token ${token}`,
                    },
                    success: function (response) {
                        console.log('Delete success:', response);
                        // Force reload regardless of response structure
                        location.reload();
                    },
                    error: function (xhr) {
                        console.error('Delete error:', xhr);
                        let errorMessage = 'Unknown error';
                        try {
                            const errorResponse = xhr.responseJSON;
                            errorMessage = errorResponse.detail || JSON.stringify(errorResponse);
                        } catch (e) {
                            console.error('Error parsing response:', e);
                        }
                        alert('Delete failed: ' + errorMessage);
                    }
                });
            }
        });
        
        // Handle edit expense form submission
        $('#edit-expense-form').on('submit', function (e) {
            e.preventDefault();

            const formData = {
                amount: parseFloat($('#edit_amount').val()),
                description: $('#edit_description').val(),
                expense_date: $('#edit_expense_date').val(),
                location: $('#edit_location').val(),
                category: $('#edit_category').val()
            };

            const $modal = $('#editExpenseModal');
            const currentParams = new URLSearchParams(window.location.search);

            // Check if the expense exceeds the income
            if (formData.amount > userIncome) {
                if (!confirm('The expense exceeds your income. Are you sure you want to edit this expense?')) {
                    return; // Cancel the submission
                }
            }

            $.ajax({
                url: $(this).attr('action'),
                method: 'PUT',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                headers: {
                    'Authorization': `Token ${token}`,
                },
                success: function (response) {
                    $modal.modal('hide');

                    // Small delay to ensure modal transitions complete
                    setTimeout(() => {
                        // Preserve filters while reloading
                        window.location.href = "{% url 'frontend-expense-list' %}?" + currentParams.toString();
                    }, 300);
                },
                error: function (xhr) {
                    let errorMessage = 'Unknown error';
                    try {
                        const errorResponse = xhr.responseJSON;
                        errorMessage = errorResponse.detail || JSON.stringify(errorResponse);
                    } catch (e) {
                        console.error('Error parsing response:', e);
                    }
                    alert('Update failed: ' + errorMessage);
                }
            });
        });
        function downloadYearlyPDF() {
            const year = $('#year').val().trim();
            if (!year) {
                alert('Please select a year first');
                return;
            }
            
            const token = "{{ request.session.token }}";
            const user_id = "{{ request.session.user_id }}";
            const endpoint = `/expenses/${user_id}/monthly-summary/?year=${year}`;
            
            // Show loading indicator
            const $btn = $('#download-yearly-pdf');
            const originalText = $btn.html();
            $btn.html('<i class="bi bi-hourglass-split"></i> Generating PDF...');
            $btn.prop('disabled', true);
            
            // Make sure jsPDF is properly loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error('jsPDF library not properly loaded');
                alert('PDF generation failed: Required libraries not loaded');
                $btn.html(originalText);
                $btn.prop('disabled', false);
                return;
            }
            
            // Get the monthly expense data
            $.ajax({
                url: endpoint,
                method: 'GET',
                headers: {
                    'Authorization': `Token ${token}`
                },
                success: function(expenseData) {
                    try {
                        // Use the user's income from the page variable
                        const monthlyIncome = userIncome || 5000; // Default to 5000 if userIncome is not set
                        
                        // Format data for PDF
                        const monthlyData = [];
                        let totalSpending = 0;
                        
                        // Make sure we have valid data
                        if (!expenseData.labels || !expenseData.data || expenseData.labels.length === 0) {
                            throw new Error('No expense data available for the selected year');
                        }
                        
                        for (let i = 0; i < expenseData.labels.length; i++) {
                            const monthName = expenseData.labels[i];
                            const spending = expenseData.data[i];
                            totalSpending += spending;
                            const remaining = monthlyIncome - spending;
                            
                            monthlyData.push({
                                month: monthName,
                                income: monthlyIncome.toFixed(2),
                                spending: spending.toFixed(2),
                                remaining: remaining.toFixed(2),
                                isNegative: remaining < 0 // Flag to track negative remaining values
                            });
                        }
                        
                        // Calculate yearly summary
                        const yearlyIncome = monthlyIncome * 12;
                        const yearlyRemaining = yearlyIncome - totalSpending;
                        const isYearlyPositive = yearlyRemaining >= 0;
                        
                        // Create new PDF document
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Add title
                        doc.setFontSize(18);
                        doc.text(`Yearly Expense Summary - ${year}`, 14, 22);
                        
                        // Add monthly table
                        doc.setFontSize(12);
                        doc.text('Monthly Breakdown:', 14, 35);
                        
                        // Check if autoTable is available
                        if (typeof doc.autoTable !== 'function') {
                            throw new Error('AutoTable plugin not properly loaded');
                        }
                        
                        // Create monthly table with styling
                        doc.autoTable({
                            startY: 40,
                            head: [['Month', 'Income', 'Spending', 'Remaining']],
                            body: monthlyData.map(row => [
                                row.month, 
                                `$${row.income}`, 
                                `$${row.spending}`, 
                                `$${row.remaining}`
                            ]),
                            theme: 'striped',
                            headStyles: { fillColor: [66, 139, 202] },
                            bodyStyles: { fontSize: 10 },
                            columnStyles: {
                                3: { cellWidth: 'auto' } // Adjust width for remaining column
                            },
                            didParseCell: function(data) {
                                // Check if this is a body cell in the "Remaining" column (index 3)
                                if (data.row.index >= 0 && data.column.index === 3) {
                                    const rowData = monthlyData[data.row.index];
                                    if (rowData.isNegative) {
                                        // Apply red styling for negative values
                                        data.cell.styles = data.cell.styles || {};
                                        data.cell.styles.textColor = [255, 0, 0]; // Red text
                                        data.cell.styles.fontStyle = 'bold';
                                        data.cell.styles.fillColor = [255, 230, 230]; // Light red background
                                    }
                                }
                            }
                        });
                        
                        // Add yearly summary
                        const finalY = doc.lastAutoTable.finalY + 20;
                        doc.setFontSize(14);
                        doc.text('Yearly Summary:', 14, finalY);
                        
                        // Create yearly summary table
                        doc.autoTable({
                            startY: finalY + 5,
                            head: [['Total Income', 'Total Spending', 'Total Remaining']],
                            body: [[
                                `$${yearlyIncome.toFixed(2)}`,
                                `$${totalSpending.toFixed(2)}`,
                                `$${yearlyRemaining.toFixed(2)}`
                            ]],
                            theme: 'grid',
                            headStyles: { fillColor: [92, 184, 92] },
                            didParseCell: function(data) {
                                // Style for negative yearly remaining
                                if (data.column.index === 2 && !isYearlyPositive) {
                                    data.cell.styles = data.cell.styles || {};
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.textColor = [255, 0, 0];
                                    data.cell.styles.fillColor = [255, 200, 200];
                                }
                            }
                        });
                        
                        // Add feedback message based on yearly remaining amount
                        const feedbackY = doc.lastAutoTable.finalY + 15;
                        doc.setFontSize(12);
                        
                        if (isYearlyPositive) {
                            // Positive feedback
                            doc.setTextColor(0, 128, 0); // Green text for positive feedback
                            doc.setFont('helvetica', 'bold');
                            doc.text('GREAT JOB!', 14, feedbackY);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`You saved $${yearlyRemaining.toFixed(2)} this year. Keep up the excellent financial management!`, 14, feedbackY + 7);
                            doc.text('Consider investing your savings or building your emergency fund.', 14, feedbackY + 14);
                        } else {
                            // Negative feedback
                            doc.setTextColor(192, 0, 0); // Red text for negative feedback
                            doc.setFont('helvetica', 'bold');
                            doc.text('ATTENTION!', 14, feedbackY);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`You've overspent by $${Math.abs(yearlyRemaining).toFixed(2)} this year.`, 14, feedbackY + 7);
                            doc.text('Consider reviewing your expenses and creating a budget to avoid debt.', 14, feedbackY + 14);
                            doc.text('Focus on reducing non-essential spending and increasing your income if possible.', 14, feedbackY + 21);
                        }
                        
                        // Reset text color
                        doc.setTextColor(0);
                        
                        // Add date generated
                        const today = new Date();
                        doc.setFontSize(10);
                        doc.setTextColor(100);
                        doc.text(`Generated on: ${today.toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
                        
                        // Download the PDF
                        doc.save(`Expense_Summary_${year}.pdf`);
                        
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        alert('Error generating PDF: ' + error.message);
                    } finally {
                        // Reset button
                        $btn.html(originalText);
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    console.error('Error fetching data for PDF:', xhr);
                    alert('Could not generate PDF: Error fetching expense data');
                    
                    // Reset button
                    $btn.html(originalText);
                    $btn.prop('disabled', false);
                }
            });
        }
        // Replace your existing view-receipt click handler with this
        $(document).on('click', '.view-receipt', function(e) {
            e.preventDefault();
            const pdfUrl = $(this).data('receipt-url');
            
            console.log('PDF URL from data attribute:', pdfUrl);
            
            if (!pdfUrl) {
                // Try getting from href as fallback
                const hrefUrl = $(this).attr('href');
                console.log('Falling back to href:', hrefUrl);
                
                if (hrefUrl && hrefUrl !== '#') {
                    window.open(hrefUrl, '_blank');
                    return;
                }
                
                alert('Error: Could not find the PDF URL.');
                return;
            }
            
            // Create an iframe to display the PDF instead of opening a new tab
            const modal = $('<div>', {
                class: 'modal fade',
                id: 'pdfViewerModal',
                tabindex: '-1',
                role: 'dialog'
            });
            
            const modalDialog = $('<div>', { 
                class: 'modal-dialog modal-lg',
                role: 'document'
            });
            
            const modalContent = $('<div>', { class: 'modal-content' });
            
            const modalHeader = $('<div>', { class: 'modal-header' })
                .append($('<h5>', { class: 'modal-title', text: 'Receipt Viewer' }))
                .append($('<button>', { 
                    type: 'button',
                    class: 'btn-close',
                    'data-bs-dismiss': 'modal',
                    'aria-label': 'Close'
                }));
            
            const modalBody = $('<div>', { class: 'modal-body' })
                .append($('<iframe>', {
                    src: pdfUrl,
                    width: '100%',
                    height: '500px',
                    style: 'border: none;'
                }));
            
            const modalFooter = $('<div>', { class: 'modal-footer' })
                .append($('<button>', {
                    type: 'button',
                    class: 'btn btn-secondary',
                    'data-bs-dismiss': 'modal',
                    text: 'Close'
                }))
                .append($('<a>', {
                    href: pdfUrl,
                    class: 'btn btn-primary',
                    target: '_blank',
                    text: 'Open in New Tab'
                }));
            
            // Assemble the modal
            modalContent.append(modalHeader, modalBody, modalFooter);
            modalDialog.append(modalContent);
            modal.append(modalDialog);
            
            // Add to document, show, and remove when hidden
            $('body').append(modal);
            
            const bsModal = new bootstrap.Modal(modal[0]);
            bsModal.show();
            
            modal.on('hidden.bs.modal', function() {
                $(this).remove();
            });
        });
    });
</script>
{% endblock %}